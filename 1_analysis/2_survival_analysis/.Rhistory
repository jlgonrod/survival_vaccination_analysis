print(ajusted_curve_A)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_A)
dev.off()
# print the plot
print(ajusted_curve_A)
cat("Check the subset:\n")
summary(df_over70[, c("age", "admission_datetime")])
cat("\nNumber rows:", nrow(df_over70))
generate_coxph_analysis(df_over70,
included_vars,
"Over 70 years (Group B)",
num_table = 9,
num_fig = 12)
df_over70<-as.data.frame(df_over70)
df_over70$vaccinated <-factor(
df_over70$vaccinated, levels = 0:1,
labels = c("Unvaccinated", "Vaccinated")
)
vars_descriptives <- included_vars[included_vars != "vaccinated"]
# Create the formula
string_formula <- paste("Surv(Survival_in_days, Status) ~ strata(vaccinated) + ",
paste(vars_descriptives, collapse = " + "))
formula <- as.formula(string_formula)
# Fit the Cox proportional hazards model with stratification by vaccinated status
fit <- coxph(formula, data = df_over70)
# Plot adjusted survival curves stratified by vaccinated status
custom_colors <- c("Unvaccinated" = "#f08080", "Vaccinated" = "#4fc977")
title = "Adjusted Survival Curves for Cox Proportional Hazards Model\nGroup B | ≥ 70 years"
ajusted_curve_B <- ggadjustedcurves(fit,
variable = 'vaccinated',
legend.title = "Vaccination Status",
main=title,
palette=custom_colors,
xlab='Days',
xlim=c(0,90)) +
scale_x_continuous(breaks = seq(0, 90, by = 10)) +
coord_cartesian(xlim = c(0, 86))
figure_number <- 13
# Save the plot as png
png(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".png"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_B)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_B)
dev.off()
# print the plot
print(ajusted_curve_B)
cat("Check the subset:\n")
summary(df_over60[, c("age", "admission_datetime")])
cat("\nNumber rows:", nrow(df_over60))
generate_coxph_analysis(df_over60,
included_vars,
"Over 60 years (Group C)",
num_table = 10,
num_fig = 14)
df_over60<-as.data.frame(df_over60)
df_over60$vaccinated <-factor(
df_over60$vaccinated, levels = 0:1,
labels = c("Unvaccinated", "Vaccinated")
)
vars_descriptives <- included_vars[included_vars != "vaccinated"]
# Create the formula
string_formula <- paste("Surv(Survival_in_days, Status) ~ strata(vaccinated) + ",
paste(vars_descriptives, collapse = " + "))
formula <- as.formula(string_formula)
# Fit the Cox proportional hazards model with stratification by vaccinated status
fit <- coxph(formula, data = df_over60)
# Plot adjusted survival curves stratified by vaccinated status
custom_colors <- c("Unvaccinated" = "#f08080", "Vaccinated" = "#4fc977")
title = "Adjusted Survival Curves for Cox Proportional Hazards Model\nGroup C | ≥ 60 years"
ajusted_curve_C <- ggadjustedcurves(fit,
variable = 'vaccinated',
legend.title = "Vaccination Status",
main=title,
palette=custom_colors,
xlab='Days',
xlim=c(0,90)) +
scale_x_continuous(breaks = seq(0, 90, by = 10)) +
coord_cartesian(xlim = c(0, 86))
figure_number <- 15
# Save the plot as png
png(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".png"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_C)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_C)
dev.off()
# print the plot
print(ajusted_curve_C)
cat("Check the subset:\n")
summary(df_over40[, c("age", "admission_datetime")])
cat("\nNumber rows:", nrow(df_over40))
generate_coxph_analysis(df_over40,
included_vars,
"Over 40 years (Group D)",
num_table = 11,
num_fig = 16)
df_over40<-as.data.frame(df_over40)
df_over40$vaccinated <-factor(
df_over40$vaccinated, levels = 0:1,
labels = c("Unvaccinated", "Vaccinated")
)
vars_descriptives <- included_vars[included_vars != "vaccinated"]
# Create the formula
string_formula <- paste("Surv(Survival_in_days, Status) ~ strata(vaccinated) + ",
paste(vars_descriptives, collapse = " + "))
formula <- as.formula(string_formula)
# Fit the Cox proportional hazards model with stratification by vaccinated status
fit <- coxph(formula, data = df_over40)
# Plot adjusted survival curves stratified by vaccinated status
custom_colors <- c("Unvaccinated" = "#f08080", "Vaccinated" = "#4fc977")
title = "Adjusted Survival Curves for Cox Proportional Hazards Model\nGroup D | ≥ 40 years"
ajusted_curve_D <- ggadjustedcurves(fit,
variable = 'vaccinated',
legend.title = "Vaccination Status",
main=title,
palette=custom_colors,
xlab='Days',
xlim=c(0,90)) +
scale_x_continuous(breaks = seq(0, 90, by = 10)) +
coord_cartesian(xlim = c(0, 86))
figure_number <- 17
# Save the plot as png
png(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".png"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_D)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_D)
dev.off()
# print the plot
print(ajusted_curve_D)
cat("Check the subset:\n")
summary(df_over18[, c("age", "admission_datetime")])
cat("\nNumber rows:", nrow(df_over18))
generate_coxph_analysis(df_over18,
included_vars,
"Over 18 years (Group E)",
num_table = 12,
num_fig = 18)
df_over18<-as.data.frame(df_over18)
df_over18$vaccinated <-factor(
df_over18$vaccinated, levels = 0:1,
labels = c("Unvaccinated", "Vaccinated")
)
vars_descriptives <- included_vars[included_vars != "vaccinated"]
# Create the formula
string_formula <- paste("Surv(Survival_in_days, Status) ~ strata(vaccinated) + ",
paste(vars_descriptives, collapse = " + "))
formula <- as.formula(string_formula)
# Fit the Cox proportional hazards model with stratification by vaccinated status
fit <- coxph(formula, data = df_over18)
# Plot adjusted survival curves stratified by vaccinated status
custom_colors <- c("Unvaccinated" = "#f08080", "Vaccinated" = "#4fc977")
title = "Adjusted Survival Curves for Cox Proportional Hazards Model\nGroup E | ≥ 18 years"
ajusted_curve_E <- ggadjustedcurves(fit,
variable = 'vaccinated',
legend.title = "Vaccination Status",
main=title,
palette=custom_colors,
xlab='Days',
xlim=c(0,90)) +
scale_x_continuous(breaks = seq(0, 90, by = 10)) +
coord_cartesian(xlim = c(0, 86))
figure_number <- 19
# Save the plot as png
png(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".png"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_E)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_E)
dev.off()
# print the plot
print(ajusted_curve_E)
list_subplots <- list(ajusted_curve_A, ajusted_curve_B, ajusted_curve_C, ajusted_curve_D, ajusted_curve_E)
plot_grid <- plot_grid(plotlist = list_subplots, nrow=2, ncol=3)
n_figure <- 20
# Save as png
png(paste("../OUTPUT_figures_tables/Figure_", n_figure, ".png", sep=""),
width = 40*120,
height = 25*120,
res = 200,
pointsize = 7)
print(plot_grid)
dev.off()
# Save as tiff
tiff(paste("../OUTPUT_figures_tables/Figure_", n_figure, ".tiff", sep=""),
width = 40*120,
height = 25*120,
res = 200,
pointsize = 7)
print(plot_grid)
dev.off()
# Plot
print(plot_grid)
df_3 <- read.csv("data/survival_data.csv")
# Remove columns no suitable for the analysis
df_3 <- subset(df_3, select=-c(inpatient_days,
discharge_datetime,
death_datetime))
# cast admission_datetime from chr to Date
df_3$admission_datetime <- as.Date(df_3$admission_datetime, format = "%Y-%m-%d")
# Rename columns to be more interpretable
df_3 <- df_3 %>%
rename(Status = hospital_outcome,
Survival_in_days = followup_days)
# Rename sex levels
df_3$sex <- as.factor(df_3$sex)
df_3$sex <- recode(df_3$sex, "0" = "Female",
"1" = "Male")
# Remove wave columns
one_hot_columns <- grep("wave", colnames(df_3), value = TRUE)
df_3 <- df_3[, -which(names(df_3) %in% one_hot_columns)]
rm(one_hot_columns)
vacc_df <- read.csv("../../0_get_data/data/04_Vacunacion_covid.txt", sep = '|')
vacc_df$FEC_VACUNACION <- as.Date(as.character(vacc_df$FEC_VACUNACION), format = "%Y%m%d")
# Remove previous vaccination info
df_3$vaccinated <- NA
# Merge both df_3
merged_df <- merge(df_3, vacc_df, by.x = "id", by.y = "NUHSA_ENCRIPTADO", all.x = TRUE)
# UNPROTECTED
id_unprotected <- merged_df[is.na(merged_df$FEC_VACUNACION), "id"]
df_3$vaccinated[df_3$id %in% id_unprotected] <- "Unprotected"
# All vaccines before admission are not count
merged_df <- merged_df %>%
filter(FEC_VACUNACION +14 < admission_datetime)
# PROTECTED
df_protected <- merged_df %>%
group_by(id) %>%
filter(n() >= 3) %>%
summarize(
last_dosis_date = max(FEC_VACUNACION, na.rm = TRUE),
admission_datetime = first(admission_datetime)  # All values are the same for admission_datetime
) %>%
ungroup() %>%
mutate(days_last_dosis = as.numeric(difftime(admission_datetime, last_dosis_date, units = "days")))
id_protected <- df_protected %>% filter(days_last_dosis <= 180) %>% pull(id)
df_3$vaccinated[df_3$id %in% id_protected] <- "Protected"
# INCOMPLETE
others_id <- subset(df_3, is.na(vaccinated))$id
df_incomplete <- merged_df %>%
filter(id %in% others_id) %>%
group_by(id) %>%
filter(n() > 0 & n() < 3) %>%
summarize(
last_dosis_date = max(FEC_VACUNACION, na.rm = TRUE),
admission_datetime = first(admission_datetime)  # All values are the same for admission_datetime
) %>%
ungroup %>%
mutate(days_last_dosis = as.numeric(difftime(admission_datetime, last_dosis_date, units = "days"))) %>%
filter(days_last_dosis > 180)
id_incomplete <-  df_incomplete %>% pull(id)
df_3$vaccinated[df_3$id %in% id_incomplete] <- "Incomplete"
# REMOVE OTHER CASES
df_3 <- df_3[complete.cases(df_3$vaccinated), ]
# Set as factor
df_3$vaccinated <- as.factor(df_3$vaccinated)
df_3$vaccinated <- factor(df_3$vaccinated, levels = c("Unprotected", "Protected", "Incomplete"))
# Count each possible level
cat("Vaccination subgroups:")
print(table(df_3$vaccinated))
# Create the formula
formula_string <- paste("Surv(Survival_in_days, Status) ~", paste(included_vars, collapse = " + "))
formula <- as.formula(formula_string)
# Model
cox_model_3 <- coxph(formula, data = df_3)
# Extract the model report
cox_model_summary_3 <- summary(cox_model_3)
# Extract the relevant_data
coefficients <- as.data.frame(cox_model_summary_3$coefficients)
intervals <- as.data.frame(cox_model_summary_3$conf.int)
# Combine both df_3 with relevant info
cox_model_report3 <- cbind(coefficients, intervals[, c("lower .95", "upper .95")])
remap_rows = remap_rows <- c(
"vaccinatedProtected" = "Vaccinated (Protected)",
"vaccinatedIncomplete" = "Vaccinated (Incomplete)",
"sexMale" = "Sex Male",
"age" = "Age",
"type_centerSpecialized Hospital" = "Medical Center Type Specialty",
"type_centerRegional Hospital" = "Medical Center Type Regional",
"icu" = "ICU Stay",
"wavewave_3" = "Wave 3",
"wavewave_4" = "Wave 4",
"wavewave_5" = "Wave 5",
"wavewave_6" = "Wave 6",
"wavewave_7" = "Wave 7",
"pmhx_activecancer" = "Preexisting Condition Active Cancer",
"pmhx_asthma" = "Preexisting Condition Asthma",
"pmhx_chf" = "Preexisting Condition Congestive Heart Failure",
"pmhx_chronicliver" = "Preexisting Condition Chronic Liver",
"pmhx_ckd" = "Preexisting Condition Chronic Kidney Disease",
"pmhx_copd" = "Preexisting Condition COPD",
"pmhx_dementia" = "Preexisting Condition Dementia",
"pmhx_diabetes" = "Preexisting Condition Diabetes",
"pmhx_hld" = "Preexisting Condition Hyperlipidemia",
"pmhx_htn" = "Preexisting Condition Hypertension",
"pmhx_ihd" = "Preexisting Condition Ischemic Heart Disease",
"pmhx_obesity" = "Preexisting Condition Obesity",
"pmhx_stroke" = "Preexisting Condition Stroke",
"lab_alt" = "Alanine Transaminase",
"lab_ast" = "Aspartate Transaminase",
"lab_creatinine" = "Creatinine",
"lab_crp" = "C-Reactive Protein",
"lab_ddimer" = "D-Dimer",
"lab_glucose" = "Glucose",
"lab_hct" = "Hematocrit",
"lab_hemoglobin" = "Hemoglobin",
"lab_inr" = "Normalized Prothrombin Time - INR",
"lab_ldh" = "Lactate Dehydrogenase",
"lab_leukocyte" = "Leukocyte Count",
"lab_lymphocyte" = "Lymphocyte Count",
"lab_lymphocyte_percentage" = "Lymphocyte Percentage",
"lab_mch" = "Mean Corpuscular Hemoglobin",
"lab_mcv" = "Mean Corpuscular Volume",
"lab_neutrophil" = "Neutrophil Count",
"lab_neutrophil_percentage" = "Neutrophil Percentage",
"lab_platelet" = "Platelet Count",
"lab_potassium" = "Potassium",
"lab_rbc" = "Red Blood Cell Count",
"lab_sodium" = "Sodium",
"lab_urea" = "Urea"
)
# Assign new row names using the mapper, with handling for NA
new_row_names <- ifelse(rownames(cox_model_report3) %in% names(remap_rows),
remap_rows[rownames(cox_model_report3)],
rownames(cox_model_report3))
# Assign the new row names to the DataFrame
rownames(cox_model_report3) <- new_row_names
num_table <- 13
# Save the report in excel
excel_path <- paste0("../OUTPUT_figures_tables/Table_", num_table, "_Cox_Model_Report_", "Stratification Unprotected, Protected and Incomplete",".xlsx")
#
cox_model_report_excel <- cox_model_report3 %>%
mutate(variables = row.names(cox_model_report3)) %>%
select(variables, everything())
write_xlsx(cox_model_report_excel, excel_path)
# create the foresplot
plot_title <- "Forest Plot - Hazard ratio (with 95% Confidence Interval)\nRefined model | Immunization Stratification:\nUnprotected, Protected and Incomplete protection"
foresplot <- create_forest_plot(cox_model_report3, plot_title, 21)
print(foresplot)
df_3<-as.data.frame(df_3)
df_3$vaccinated <- factor(df_3$vaccinated, levels = c("Unprotected", "Incomplete", "Protected"))
vars_descriptives <- included_vars[included_vars != "vaccinated"]
# Create the formula
string_formula <- paste("Surv(Survival_in_days, Status) ~ strata(vaccinated) + ",
paste(vars_descriptives, collapse = " + "))
formula <- as.formula(string_formula)
# Fit the Cox proportional hazards model with stratification by vaccinated status
fit <- coxph(formula, data = df_3)
# Plot adjusted survival curves stratified by vaccinated status
custom_colors <- c("Unprotected" = "#AB6BEA", "Incomplete" = "#EBAF54", "Protected" = "#4fc977")
title = "Adjusted Survival Curves for Cox Proportional Hazards Model\nImmunization Stratification:\nUnprotected, Protected and Incomplete protection"
ajusted_curve_3 <- ggadjustedcurves(fit,
variable = 'vaccinated',
legend.title = "Vaccination Status",
main=title,
palette=custom_colors,
xlab='Days',
xlim=c(0,90)) +
scale_x_continuous(breaks = seq(0, 90, by = 10)) +
coord_cartesian(xlim = c(0, 86))
figure_number <- 22
# Save the plot as png
png(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".png"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_3)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 2400,
height = 1600,
res = 200,
pointsize = 7)
print(ajusted_curve_3)
dev.off()
# print the plot
print(ajusted_curve_3)
string_formula <- paste("Surv(Survival_in_days, Status) ~ strata(vaccinated) + ",
paste(vars_descriptives, collapse = " + "))
formula <- as.formula(string_formula)
# Fit the Cox proportional hazards model with stratification by vaccinated status
fit <- coxph(formula, data = df)
# Plot adjusted survival curves stratified by vaccinated status
custom_colors <- c("Unvaccinated" = "#f08080", "Vaccinated" = "#4fc977")
risktable_1 <- ggsurvtable(survfit(fit, data = df_over70),
survtable = "risk.table",
color = "strata",
palette = custom_colors,
legend.labs = c("Unvaccinated", "Vaccinated"),
xlab = "Days",
ylab = "Vaccination Status"
) +
theme(legend.position = "none") +
ggtitle("Number at risk: Analysis 1")
figure_number <- 23
# Save the plot as png
png(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".png"),
width = 1300,
height = 500,
res = 150,
pointsize = 7)
print(risktable_1)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 1300,
height = 500,
res = 150,
pointsize = 7)
print(risktable_1)
dev.off()
# print the plot
print(risktable_1)
string_formula <- paste("Surv(Survival_in_days, Status) ~ strata(vaccinated) + ",
paste(vars_descriptives, collapse = " + "))
formula <- as.formula(string_formula)
# Fit the Cox proportional hazards model with stratification by vaccinated status
fit <- coxph(formula, data = df_3)
# Plot adjusted survival curves stratified by vaccinated status
custom_colors <- c("Unprotected" = "#AB6BEA", "Protected" = "#4fc977", "Incomplete" = "#EBAF54")
risktable_3 <- ggsurvtable(survfit(fit, data = df_3),
survtable = "risk.table",
color = "strata",
palette = custom_colors,
xlab = "Days",
ylab = "Vaccination Status"
) +
theme(legend.position = "none") +
ggtitle("Number at risk: Analysis 3")
figure_number <- 24
# Save the plot as png
png(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".png"),
width = 1300,
height = 500,
res = 150,
pointsize = 7)
print(risktable_3)
dev.off()
#Save the plot as tiff
tiff(paste0("../OUTPUT_figures_tables/Figure_", figure_number, ".tiff"),
width = 1300,
height = 500,
res = 150,
pointsize = 7)
print(risktable_3)
dev.off()
# print the plot
print(risktable_3)
#The next code help to check the survival per vaccination status and time.
#```{r}
## ############## Day 1: Survival Analysis #################
#
## Analyze survival for non-vaccinated on Day 1
#analyze_survival(df, "Survival_in_days", "Status", 0, 0)
#
## Analyze survival for vaccinated on Day 1
#analyze_survival(df, "Survival_in_days", "Status", 1, 0)
#
## ############## Day 1: Survival Analysis #################
#
## Analyze survival for non-vaccinated on Day 50
#analyze_survival(df, "Survival_in_days", "Status", 0, 50)
#
#
## Analyze survival for vaccinated on last day
#analyze_survival(df, "Survival_in_days", "Status", 1, max(subset(df, vaccinated == 1)$Survival_in_days))
#```
